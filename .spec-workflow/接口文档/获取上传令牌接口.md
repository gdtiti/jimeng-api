# 获取上传令牌接口文档

## 接口概述

**接口功能**: 获取图片上传所需的AWS S3认证令牌，用于后续的图片上传流程

**请求方法**: POST
**接口路径**: `/mweb/v1/get_upload_token`
**支持区域**: 即梦中国、即梦国际

## 请求参数

### URL参数 (Query Parameters)

即梦国际版本需要额外参数：

| 参数名 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| aid | string | 是 (仅US) | 513641 | 应用ID，即梦国际固定值 |
| web_version | string | 是 (仅US) | "7.5.0" | Web版本号 |
| da_version | string | 是 (仅US) | "3.3.2" | DA版本号 |
| aigc_features | string | 是 (仅US) | "app_lip_sync" | AIGC功能标识 |

### 请求体 (Request Body)

| 参数名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| scene | number | 是 | 上传场景，固定为2 |

## 请求示例

### 即梦中国请求示例

```javascript
const response = await axios.post("https://jimeng.jianying.com/mweb/v1/get_upload_token", {
  scene: 2
}, {
  headers: {
    // 标准请求头...
  }
});
```

### 即梦国际请求示例

```javascript
const response = await axios.post("https://api-proxy-1.deno.dev/dreamina/us/mweb/v1/get_upload_token", {
  scene: 2
}, {
  params: {
    aid: "513641",
    web_version: "7.5.0",
    da_version: "3.3.2",
    aigc_features: "app_lip_sync"
  },
  headers: {
    // 国际版请求头...
  }
});
```

## 响应结构

### 成功响应 (200)

```json
{
  "access_key_id": "AKIA...",
  "secret_access_key": "secret...",
  "session_token": "FwoG...",
  "service_id": "tb4s082cfz",
  "space_name": "wopfjsm1ax"  // 仅即梦国际
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| access_key_id | string | AWS访问密钥ID |
| secret_access_key | string | AWS访问密钥Secret |
| session_token | string | AWS会话令牌 |
| service_id | string | 服务ID，中国版默认"tb4s082cfz" |
| space_name | string | 空间名称，国际版默认"wopfjsm1ax" |

### 错误响应

```json
{
  "ret": "非0错误码",
  "errmsg": "错误信息描述"
}
```

## 头部构建

### 通用请求头

```javascript
{
  "Accept": "application/json, text/plain, */*",
  "Accept-Encoding": "gzip, deflate, br, zstd",
  "Accept-language": "zh-CN,zh;q=0.9",
  "Cache-control": "no-cache",
  "Pragma": "no-cache",
  "Priority": "u=1, i",
  "Sec-Ch-Ua": '"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',
  "Sec-Ch-Ua-Mobile": "?0",
  "Sec-Ch-Ua-Platform": '"Windows"',
  "Sec-Fetch-Dest": "empty",
  "Sec-Fetch-Mode": "cors",
  "Sec-Fetch-Site": "same-origin",
  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"
}
```

### 地区特定头部

| 字段名 | 即梦中国 | 即梦国际 |
|--------|----------|----------|
| Origin | `https://jimeng.jianying.com` | `https://api-proxy-1.deno.dev` |
| Referer | `https://jimeng.jianying.com/` | `https://api-proxy-1.deno.dev/` |
| Appid | 513695 | 513641 |

## Cookie构建

### Cookie生成规则

基于refreshToken生成标准认证cookie：

```javascript
function generateCookie(refreshToken) {
  const isUS = refreshToken.toLowerCase().startsWith('us-');
  const token = isUS ? refreshToken.substring(3) : refreshToken;

  return [
    `_tea_web_id=${WEB_ID}`,
    `is_staff_user=false`,
    `store-region=${isUS ? 'us' : 'cn-gd'}`,
    `store-region-src=uid`,
    `sid_guard=${token}%7C${timestamp}%7C5184000%7CMon%2C+03-Feb-2025+08%3A17%3A09+GMT`,
    `uid_tt=${USER_ID}`,
    `uid_tt_ss=${USER_ID}`,
    `sid_tt=${token}`,
    `sessionid=${token}`,
    `sessionid_ss=${token}`,
    `sid_tt=${token}`
  ].join("; ");
}
```

## SessionID组织

### SessionID来源

- **即梦中国**: 使用refreshToken的完整值作为sessionid
- **即梦国际**: 使用refreshToken去掉"us-"前缀后的值作为sessionid

### SessionID在Cookie中的位置

```javascript
// Cookie中包含以下session相关字段
sessionid=${token}
sessionid_ss=${token}
sid_tt=${token}
sid_guard=${token}%7C${timestamp}%7C5184000%7C...
```

## 使用流程

1. **获取上传令牌**: 调用此接口获取AWS认证信息
2. **申请上传权限**: 使用获取的令牌申请具体的上传权限
3. **上传文件**: 获得上传地址后上传图片文件
4. **提交上传**: 确认上传完成，获取最终图片URI

## 注意事项

1. **区域差异**: 即梦国际版本需要在URL参数中添加额外的认证参数
2. **服务ID差异**:
   - 即梦中国: `service_id = "tb4s082cfz"`
   - 即梦国际: `space_name = "wopfjsm1ax"`
3. **令牌时效性**: 获取的AWS令牌有时效性，建议在单次上传流程中使用
4. **安全考虑**: AWS凭证信息应该在内存中临时存储，不应持久化
5. **重试机制**: 建议实现适当的重试逻辑处理网络异常

## 错误处理

常见错误码及处理建议：

- **网络错误**: 检查网络连接，实现重试机制
- **认证失败**: 检查refreshToken有效性，确认cookie构建正确
- **服务不可用**: 检查API服务状态，考虑使用备用服务端点
- **参数错误**: 验证请求参数格式，特别是scene参数值
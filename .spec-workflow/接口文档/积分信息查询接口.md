# 积分信息查询接口文档

## 接口概述

**接口功能**: 查询用户的积分信息，包括赠送积分、购买积分、VIP积分等详细信息

**请求方法**: POST
**接口路径**: `/commerce/v1/benefits/user_credit`
**支持区域**: 即梦中国、即梦国际
**使用场景**: 生成任务前检查积分状态、积分消费记录查询

## 请求参数

### URL参数 (Query Parameters)

#### 通用参数

| 参数名 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| aid | string | 是 | - | 应用ID |
| device_platform | string | 是 | "web" | 设备平台 |
| region | string | 是 | - | 区域: "cn" 或 "US" |
| webId | string | 是 | - | Web ID |
| da_version | string | 是 | "3.3.2" | DA版本号 |
| web_version | string | 是 | "7.5.0" | Web版本号 |
| aigc_features | string | 是 | "app_lip_sync" | AIGC功能标识 |
| web_component_open_flag | number | 是 | 1 | Web组件开启标志 |

### 请求体 (Request Body)

```json
{
  "data": {}
}
```

注意：请求体中的`data`字段为空对象，所有参数通过URL参数传递。

## 请求头构建

### 必需请求头

```javascript
{
  "Accept": "application/json, text/plain, */*",
  "Accept-Encoding": "gzip, deflate, br, zstd",
  "Accept-language": "zh-CN,zh;q=0.9",
  "Cache-control": "no-cache",
  "Pragma": "no-cache",
  "Priority": "u=1, i",
  "Appvr": "1.0.0",
  "Pf": "7",
  "Sec-Ch-Ua": '"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',
  "Sec-Ch-Ua-Mobile": "?0",
  "Sec-Ch-Ua-Platform": '"Windows"',
  "Sec-Fetch-Dest": "empty",
  "Sec-Fetch-Mode": "cors",
  "Sec-Fetch-Site": "same-origin",
  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
  "Origin": "https://jimeng.jianying.com",
  "Referer": "https://jimeng.jianying.com/ai-tool/image/generate",
  "Appid": "513695",
  "Cookie": "generated_cookie_string",
  "Device-Time": "device_timestamp",
  "Sign": "generated_signature",
  "Sign-Ver": "1"
}
```

### 地区特定头部

| 字段名 | 即梦中国 | 即梦国际 |
|--------|----------|----------|
| Origin | https://jimeng.jianying.com | https://commerce.us.capcut.com |
| Referer | https://jimeng.jianying.com/ai-tool/image/generate | https://commerce.us.capcut.com/ |
| Appid | 513695 | 513641 |

## 请求示例

### 基础查询请求

```javascript
async function getCreditInfo(refreshToken) {
  const requestData = {
    data: {}
  };

  const response = await request("POST", "/commerce/v1/benefits/user_credit", refreshToken, {
    data: requestData,
    headers: {
      Referer: "https://jimeng.jianying.com/ai-tool/image/generate",
    },
    noDefaultParams: true
  });

  return response;
}
```

### 国际版查询请求

```javascript
async function getCreditInfoUS(refreshToken) {
  const usToken = `us-${refreshToken}`;
  const requestData = {
    data: {}
  };

  const response = await request("POST", "/commerce/v1/benefits/user_credit", usToken, {
    data: requestData,
    headers: {
      Referer: "https://commerce.us.capcut.com/",
    },
    noDefaultParams: true
  });

  return response;
}
```

## 响应结构

### 成功响应 (200)

```json
{
  "ret": "0",
  "errmsg": "success",
  "data": {
    "credit": {
      "gift_credit": 1000,
      "purchase_credit": 500,
      "vip_credit": 2000,
      "total_credit": 3500,
      "frozen_credit": 0,
      "expire_credit": 50,
      "today_consume": 100,
      "today_receive": 0,
      "level_info": {
        "level": 3,
        "level_name": "高级用户",
        "next_level_credit": 5000,
        "current_level_credit": 3500
      },
      "benefit_status": {
        "can_receive_daily": true,
        "last_receive_time": 1640995200000,
        "next_receive_time": 1641081600000,
        "receive_quota": 100,
        "received_quota": 0
      }
    },
    "consume_history": [
      {
        "consume_id": "consume_123",
        "consume_type": "image_generation",
        "consume_amount": 10,
        "balance_before": 3510,
        "balance_after": 3500,
        "create_time": 1640995200000,
        "description": "图片生成消费",
        "task_id": "task_456"
      }
    ],
    "receive_history": [
      {
        "receive_id": "receive_789",
        "receive_type": "daily_bonus",
        "receive_amount": 100,
        "balance_before": 3400,
        "balance_after": 3500,
        "create_time": 1640995200000,
        "description": "每日签到奖励"
      }
    ]
  }
}
```

### 响应字段说明

#### credit 对象

| 字段名 | 类型 | 说明 |
|--------|------|------|
| gift_credit | number | 赠送积分 |
| purchase_credit | number | 购买积分 |
| vip_credit | number | VIP积分 |
| total_credit | number | 总积分 |
| frozen_credit | number | 冻结积分 |
| expire_credit | number | 即将过期积分 |
| today_consume | number | 今日消费积分 |
| today_receive | number | 今日获得积分 |

#### level_info 对象

| 字段名 | 类型 | 说明 |
|--------|------|------|
| level | number | 用户等级 |
| level_name | string | 等级名称 |
| next_level_credit | number | 下一等级所需积分 |
| current_level_credit | number | 当前等级积分 |

#### benefit_status 对象

| 字段名 | 类型 | 说明 |
|--------|------|------|
| can_receive_daily | boolean | 是否可以领取每日积分 |
| last_receive_time | number | 上次领取时间戳 |
| next_receive_time | number | 下次可领取时间戳 |
| receive_quota | number | 可领取积分数量 |
| received_quota | number | 已领取积分数量 |

#### consume_history 数组

| 字段名 | 类型 | 说明 |
|--------|------|------|
| consume_id | string | 消费记录ID |
| consume_type | string | 消费类型 |
| consume_amount | number | 消费积分数量 |
| balance_before | number | 消费前积分余额 |
| balance_after | number | 消费后积分余额 |
| create_time | number | 消费时间戳 |
| description | string | 消费描述 |
| task_id | string | 关联任务ID |

#### receive_history 数组

| 字段名 | 类型 | 说明 |
|--------|------|------|
| receive_id | string | 接收记录ID |
| receive_type | string | 接收类型 |
| receive_amount | number | 接收积分数量 |
| balance_before | number | 接收前积分余额 |
| balance_after | number | 接收后积分余额 |
| create_time | number | 接收时间戳 |
| description | string | 接收描述 |

## 积分类型说明

### 积分分类

| 积分类型 | 说明 | 获取方式 | 使用优先级 |
|----------|------|----------|------------|
| VIP积分 | VIP用户专享积分 | VIP会员赠送 | 最高 |
| 购买积分 | 用户购买的积分 | 付费购买 | 中等 |
| 赠送积分 | 系统赠送的积分 | 活动赠送、每日签到 | 最低 |

### 消费优先级

1. **VIP积分** - 优先消耗VIP积分
2. **购买积分** - VIP积分不足时消耗购买积分
3. **赠送积分** - 最后消耗赠送积分

## 常见错误码

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| 0 | 成功 | - |
| 2001 | 用户不存在 | 检查refreshToken有效性 |
| 2002 | 参数错误 | 检查请求参数格式 |
| 2003 | 服务繁忙 | 稍后重试 |
| 2004 | 权限不足 | 检查用户权限 |
| 2005 | 数据获取失败 | 重试或联系客服 |

## 使用场景

### 1. 生成前积分检查

```javascript
async function checkCreditBeforeGeneration(refreshToken, requiredCredit = 10) {
  try {
    const creditInfo = await getCreditInfo(refreshToken);
    const { total_credit, gift_credit, purchase_credit, vip_credit } = creditInfo.credit;

    console.log(`积分信息: 赠送=${gift_credit}, 购买=${purchase_credit}, VIP=${vip_credit}, 总计=${total_credit}`);

    if (total_credit < requiredCredit) {
      // 尝试接收每日积分
      if (creditInfo.credit.benefit_status.can_receive_daily) {
        console.log('积分不足，尝试领取每日积分');
        const newCredit = await receiveCredit(refreshToken);
        return newCredit >= requiredCredit;
      }

      console.log(`积分不足: 需要${requiredCredit}, 当前${total_credit}`);
      return false;
    }

    return true;
  } catch (error) {
    console.error('积分查询失败:', error.message);
    return false;
  }
}
```

### 2. 积分消费记录跟踪

```javascript
class CreditTracker {
  constructor(refreshToken) {
    this.refreshToken = refreshToken;
    this.lastBalance = 0;
  }

  async updateBalance() {
    const creditInfo = await getCreditInfo(this.refreshToken);
    this.lastBalance = creditInfo.credit.total_credit;
    return creditInfo;
  }

  async trackConsumption(expectedConsume) {
    const beforeBalance = this.lastBalance;
    const creditInfo = await this.updateBalance();
    const actualConsume = beforeBalance - creditInfo.credit.total_credit;

    console.log(`积分消费: 预期${expectedConsume}, 实际${actualConsume}`);

    if (Math.abs(actualConsume - expectedConsume) > 1) {
      console.warn('积分消费异常，请检查');
    }

    return {
      expected: expectedConsume,
      actual: actualConsume,
      balance: creditInfo.credit.total_credit
    };
  }
}
```

### 3. 智能积分管理

```javascript
class CreditManager {
  constructor(refreshToken) {
    this.refreshToken = refreshToken;
    this.creditCache = null;
    this.cacheExpiry = 0;
  }

  async getCachedCredit() {
    if (Date.now() > this.cacheExpiry) {
      this.creditCache = await getCreditInfo(this.refreshToken);
      this.cacheExpiry = Date.now() + 30 * 1000; // 缓存30秒
    }

    return this.creditCache;
  }

  async ensureSufficientCredit(requiredCredit) {
    const creditInfo = await this.getCachedCredit();

    // 检查积分是否充足
    if (creditInfo.credit.total_credit >= requiredCredit) {
      return { sufficient: true, creditInfo };
    }

    // 尝试领取每日积分
    if (creditInfo.credit.benefit_status.can_receive_daily) {
      try {
        const newBalance = await receiveCredit(this.refreshToken);
        this.cacheExpiry = 0; // 清除缓存
        const updatedInfo = await this.getCachedCredit();

        return {
          sufficient: updatedInfo.credit.total_credit >= requiredCredit,
          creditInfo: updatedInfo,
          receivedDaily: true
        };
      } catch (error) {
        console.error('领取每日积分失败:', error);
      }
    }

    return {
      sufficient: false,
      creditInfo: creditInfo,
      receivedDaily: false
    };
  }

  getCreditBreakdown() {
    const creditInfo = this.creditCache;
    if (!creditInfo) return null;

    return {
      total: creditInfo.credit.total_credit,
      breakdown: {
        vip: creditInfo.credit.vip_credit,
        purchased: creditInfo.credit.purchase_credit,
        gifted: creditInfo.credit.gift_credit
      },
      percentage: {
        vip: (creditInfo.credit.vip_credit / creditInfo.credit.total_credit * 100).toFixed(1),
        purchased: (creditInfo.credit.purchase_credit / creditInfo.credit.total_credit * 100).toFixed(1),
        gifted: (creditInfo.credit.gift_credit / creditInfo.credit.total_credit * 100).toFixed(1)
      }
    };
  }
}
```

## 地区差异

### 即梦中国

- **基础URL**: `https://jimeng.jianying.com`
- **货币单位**: 积分 (Credit)
- **每日奖励**: 100积分
- **积分规则**: 支持多种积分获取方式

### 即梦国际

- **基础URL**: `https://commerce.us.capcut.com`
- **货币单位**: Credits
- **每日奖励**: 可能不同
- **积分规则**: 遵循国际版规则

## 性能优化

### 缓存策略

```javascript
const creditCache = new Map();
const CACHE_TTL = 30 * 1000; // 30秒缓存

function getCachedCreditInfo(refreshToken) {
  const cacheKey = refreshToken;
  const cached = creditCache.get(cacheKey);

  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data;
  }

  return null;
}

function setCachedCreditInfo(refreshToken, data) {
  const cacheKey = refreshToken;
  creditCache.set(cacheKey, {
    data: data,
    timestamp: Date.now()
  });

  // 定期清理过期缓存
  setTimeout(() => {
    const cached = creditCache.get(cacheKey);
    if (cached && Date.now() - cached.timestamp >= CACHE_TTL) {
      creditCache.delete(cacheKey);
    }
  }, CACHE_TTL);
}
```

### 批量查询优化

```javascript
async function batchCreditQuery(refreshTokens) {
  const results = new Map();
  const uniqueTokens = [...new Set(refreshTokens)];

  // 并发查询，但限制并发数
  const concurrency = 5;
  const batches = [];

  for (let i = 0; i < uniqueTokens.length; i += concurrency) {
    batches.push(uniqueTokens.slice(i, i + concurrency));
  }

  for (const batch of batches) {
    const batchPromises = batch.map(async token => {
      try {
        const creditInfo = await getCreditInfo(token);
        return { token, creditInfo, error: null };
      } catch (error) {
        return { token, creditInfo: null, error };
      }
    });

    const batchResults = await Promise.allSettled(batchPromises);

    batchResults.forEach(result => {
      if (result.status === 'fulfilled') {
        const { token, creditInfo, error } = result.value;
        if (error) {
          results.set(token, { error });
        } else {
          results.set(token, creditInfo);
        }
      }
    });
  }

  return results;
}
```

## 监控和日志

### 积分监控指标

```javascript
const creditMetrics = {
  totalQueries: 0,
  successfulQueries: 0,
  failedQueries: 0,
  avgResponseTime: 0,
  lowBalanceWarnings: 0,
  dailyClaimsAttempts: 0,
  dailyClaimSuccesses: 0
};

function recordCreditQuery(success, responseTime, balance = 0) {
  creditMetrics.totalQueries++;

  if (success) {
    creditMetrics.successfulQueries++;
    if (balance < 100) {
      creditMetrics.lowBalanceWarnings++;
    }
  } else {
    creditMetrics.failedQueries++;
  }

  const totalProcessed = creditMetrics.successfulQueries + creditMetrics.failedQueries;
  creditMetrics.avgResponseTime =
    (creditMetrics.avgResponseTime * (totalProcessed - 1) + responseTime) / totalProcessed;
}

function recordDailyClaimAttempt(success) {
  creditMetrics.dailyClaimsAttempts++;
  if (success) {
    creditMetrics.dailyClaimSuccesses++;
  }
}
```

### 日志记录

```javascript
function logCreditQuery(refreshToken, creditInfo, responseTime) {
  console.log('积分查询完成:', {
    tokenHash: refreshToken.substring(0, 8) + '***',
    totalCredit: creditInfo.credit.total_credit,
    breakdown: {
      gift: creditInfo.credit.gift_credit,
      purchase: creditInfo.credit.purchase_credit,
      vip: creditInfo.credit.vip_credit
    },
    canReceiveDaily: creditInfo.credit.benefit_status.can_receive_daily,
    responseTime: responseTime,
    timestamp: new Date().toISOString()
  });
}
```

## 错误处理

### 重试机制

```javascript
async function getCreditWithRetry(refreshToken, maxRetries = 3) {
  let lastError = null;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const result = await getCreditInfo(refreshToken);
      return result;
    } catch (error) {
      lastError = error;

      if (attempt === maxRetries) {
        break;
      }

      if (isRetryableError(error)) {
        const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
        console.log(`积分查询失败，${delay}ms后重试 (尝试 ${attempt}/${maxRetries})`);
        await new Promise(resolve => setTimeout(resolve, delay));
      } else {
        break;
      }
    }
  }

  throw lastError;
}

function isRetryableError(error) {
  const retryableMessages = [
    'timeout',
    'network',
    'connection',
    'service unavailable'
  ];

  return retryableMessages.some(msg =>
    error.message.toLowerCase().includes(msg)
  );
}
```

## 安全考虑

1. **令牌保护**: 保护refreshToken不被泄露
2. **数据验证**: 验证响应数据的完整性
3. **频率限制**: 避免过于频繁的查询请求
4. **缓存安全**: 合理设置缓存过期时间
5. **HTTPS传输**: 确保所有请求通过HTTPS传输
6. **错误信息**: 避免在错误信息中泄露敏感信息
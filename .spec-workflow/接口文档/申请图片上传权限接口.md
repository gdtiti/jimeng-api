# 申请图片上传权限接口文档

## 接口概述

**接口功能**: 申请具体的图片上传权限，获取上传地址和认证信息

**请求方法**: GET
**接口路径**: `/?Action=ApplyImageUpload&Version=2018-08-01`
**服务提供商**: AWS ImageX (字节跳动图片存储服务)
**支持区域**: 即梦中国、即梦国际

## 请求参数

### URL参数 (Query Parameters)

| 参数名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| Action | string | 是 | 固定值: "ApplyImageUpload" |
| Version | string | 是 | 固定值: "2018-08-01" |
| ServiceId | string | 是 | 服务ID，通过上传令牌接口获取 |
| FileSize | number | 是 | 文件大小（字节） |
| s | string | 是 | 随机字符串，用于防重复请求 |
| device_platform | string | 否 (仅US) | "web" |

## 请求URL构建

### 即梦中国URL

```
https://imagex.bytedanceapi.com/?Action=ApplyImageUpload&Version=2018-08-01&ServiceId={service_id}&FileSize={file_size}&s={random_string}
```

### 即梦国际URL

```
https://imagex16-normal-us-ttp.capcutapi.us/?Action=ApplyImageUpload&Version=2018-08-01&ServiceId={service_id}&FileSize={file_size}&s={random_string}&device_platform=web
```

## AWS签名认证

### 签名生成流程

1. **创建规范请求**
   - HTTP方法: GET
   - 规范URI: /
   - 规范查询字符串: 按字母顺序排列的查询参数
   - 规范头部: 包含x-amz-date和x-amz-security-token
   - 已签名头部: 包含的头部名称列表
   - 请求载荷哈希: 空字符串的SHA256哈希

2. **创建待签名字符串**
   - 算法: AWS4-HMAC-SHA256
   - 请求日期时间: ISO格式时间戳
   - 凭证范围: date/region/service/aws4_request
   - 规范请求哈希: 规范请求的SHA256哈希

3. **计算签名**
   - 派生密钥: AWS4 -> 日期 -> 区域 -> 服务 -> 签名
   - HMAC-SHA256计算最终签名

### 签名示例代码

```javascript
function createSignature(method, url, headers, accessKeyId, secretAccessKey, sessionToken) {
  const urlObj = new URL(url);
  const timestamp = headers['x-amz-date'];
  const date = timestamp.substr(0, 8);
  const region = 'cn-north-1';
  const service = 'imagex';

  // 构建规范请求
  const canonicalRequest = [
    method.toUpperCase(),
    urlObj.pathname || '/',
    // 规范化查询参数...
    // 规范化头部...
    '',
    headersToSign.join(';'),
    crypto.createHash('sha256').update('').digest('hex')
  ].join('\n');

  // 生成最终签名
  const signature = crypto.createHmac('sha256', signingKey)
    .update(stringToSign)
    .digest('hex');

  return `AWS4-HMAC-SHA256 Credential=${accessKeyId}/${date}/${region}/${service}/aws4_request, SignedHeaders=${signedHeaders}, Signature=${signature}`;
}
```

## 请求头构建

### 必需请求头

| 头部名 | 值 | 说明 |
|--------|-----|------|
| accept | "*/*" | 接受任何响应类型 |
| authorization | AWS4-HMAC-SHA256签名 | AWS签名认证 |
| origin | 域名来源 | 根据地区设置 |
| referer | 来源页面 | 根据地区设置 |
| user-agent | 浏览器标识 | Chrome浏览器标识 |
| x-amz-date | ISO格式时间戳 | 请求时间戳 |
| x-amz-security-token | 会话令牌 | 从上传令牌接口获取 |

### 地区特定头部

| 字段名 | 即梦中国 | 即梦国际 |
|--------|----------|----------|
| origin | https://jimeng.jianying.com | https://api-proxy-1.deno.dev |
| referer | https://jimeng.jianying.com/ai-tool/generate | https://api-proxy-1.deno.dev/ai-tool/generate |

## 请求示例

### 完整请求示例

```javascript
const timestamp = new Date().toISOString().replace(/[:\-]/g, '').replace(/\.\d{3}Z$/, 'Z');
const randomStr = Math.random().toString(36).substring(2, 12);
const fileSize = 1024000; // 1MB

const url = `https://imagex.bytedanceapi.com/?Action=ApplyImageUpload&Version=2018-08-01&ServiceId=tb4s082cfz&FileSize=${fileSize}&s=${randomStr}`;

const headers = {
  'x-amz-date': timestamp,
  'x-amz-security-token': sessionToken
};

const authorization = createSignature('GET', url, headers, accessKeyId, secretAccessKey, sessionToken);

const response = await fetch(url, {
  method: 'GET',
  headers: {
    'accept': '*/*',
    'accept-language': 'zh-CN,zh;q=0.9',
    'authorization': authorization,
    'origin': 'https://jimeng.jianying.com',
    'referer': 'https://jimeng.jianying.com/ai-tool/generate',
    'sec-ch-ua': '"Not A(Brand";v="8", "Chromium";v="132", "Google Chrome";v="132"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'sec-fetch-dest': 'empty',
    'sec-fetch-mode': 'cors',
    'sec-fetch-site': 'cross-site',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36',
    'x-amz-date': timestamp,
    'x-amz-security-token': sessionToken,
  }
});
```

## 响应结构

### 成功响应 (200)

```json
{
  "Result": {
    "UploadAddress": {
      "SessionKey": "session_key_string",
      "UploadHosts": [
        "imagex-server.example.com"
      ],
      "StoreInfos": [
        {
          "StoreUri": "upload/v1/abc123def456",
          "Auth": "Bearer auth_token_string"
        }
      ]
    }
  },
  "ResponseMetadata": {
    "RequestId": "request_id_string"
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| Result | object | 上传结果信息 |
| UploadAddress | object | 上传地址信息 |
| SessionKey | string | 会话密钥，用于后续提交上传 |
| UploadHosts | array | 上传服务器地址列表 |
| StoreInfos | array | 存储信息列表 |
| StoreUri | string | 存储URI，用于构建上传URL |
| Auth | string | 认证令牌，用于文件上传 |
| ResponseMetadata | object | 响应元数据 |
| RequestId | string | 请求ID，用于问题排查 |

### 错误响应

```json
{
  "ResponseMetadata": {
    "Error": {
      "Code": "InvalidAccessKeyId",
      "Message": "The AWS access key Id you provided does not exist in our records."
    },
    "RequestId": "request_id_string"
  }
}
```

## 常见错误码

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| InvalidAccessKeyId | 访问密钥无效 | 检查access_key_id是否正确 |
| SignatureDoesNotMatch | 签名不匹配 | 检查签名计算过程 |
| AccessDenied | 访问被拒绝 | 检查权限和令牌时效性 |
| InternalServerError | 服务器内部错误 | 重试请求 |
| ServiceUnavailable | 服务不可用 | 稍后重试 |

## 使用流程

1. **准备文件信息**: 获取文件大小，生成随机字符串
2. **构建请求URL**: 使用ServiceId、FileSize等参数
3. **生成AWS签名**: 使用临时凭证计算签名
4. **发送请求**: 带上完整的认证头信息
5. **解析响应**: 提取上传地址和认证信息
6. **进行文件上传**: 使用获取的信息上传文件

## 安全注意事项

1. **临时凭证**: AWS临时凭证有时效性，应在有效期内使用
2. **签名安全**: 签名计算过程要确保时间戳准确性
3. **文件大小**: FileSize必须与实际文件大小一致
4. **随机字符串**: 每次请求使用不同的随机字符串防止重放攻击
5. **HTTPS**: 必须使用HTTPS协议传输

## 重试机制

建议实现以下重试策略：

```javascript
const maxRetries = 3;
const retryDelay = 1000; // 1秒

async function applyImageUploadWithRetry(requestParams, retryCount = 0) {
  try {
    return await applyImageUpload(requestParams);
  } catch (error) {
    if (retryCount < maxRetries && isRetryableError(error)) {
      await new Promise(resolve => setTimeout(resolve, retryDelay * (retryCount + 1)));
      return applyImageUploadWithRetry(requestParams, retryCount + 1);
    }
    throw error;
  }
}
```

## 调试建议

1. **日志记录**: 记录请求URL、时间戳、签名等信息
2. **错误分析**: 分析ResponseMetadata中的错误信息
3. **网络监控**: 监控请求延迟和成功率
4. **凭证管理**: 跟踪临时凭证的使用情况和时效性
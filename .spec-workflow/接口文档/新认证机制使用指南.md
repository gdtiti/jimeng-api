# 新认证机制使用指南

## 概述

本文档介绍了新的认证机制和URL配置系统的使用方法，支持更灵活的cookie字符串解析和多地址轮询功能。

## 新特性

### 1. 智能Cookie解析
- **新格式**: 支持完整的cookie字符串（用"....."分隔）
- **旧格式**: 兼容原有的refreshToken格式
- **自动地区检测**: 通过`capcut_locale`字段自动判断地区

### 2. 多地址轮询
- **故障转移**: 支持多个备用URL
- **负载均衡**: 随机、轮询、故障转移策略
- **动态配置**: 支持运行时URL配置

### 3. 增强的请求处理
- **智能重试**: 根据错误类型智能重试
- **性能监控**: 请求性能统计和监控
- **缓存优化**: 认证信息缓存管理

## 使用方法

### 基础用法

```javascript
import { request } from './api/controllers/core-enhanced';

// 使用新的cookie字符串格式
const cookieString = "_tea_web_id=123.....sid_tt=token.....capcut_locale=en.....sessionid=token";

// 发送请求
const response = await request(
  'POST',
  '/mweb/v1/aigc_draft/generate',
  cookieString,
  {
    data: { /* 请求数据 */ },
    serviceType: 'jimeng'  // 指定服务类型
  }
);
```

### 地区自动判断

```javascript
// 中国版cookie - capcut_locale=zh-CN
const cnCookie = "_tea_web_id=123.....sid_tt=token.....capcut_locale=zh-CN.....sessionid=token";

// 国际版cookie - capcut_locale=en
const usCookie = "_tea_web_id=123.....sid_tt=token.....capcut_locale=en.....sessionid=token";

// 系统会自动判断地区并选择对应的API端点
```

### 向后兼容

```javascript
// 旧格式仍然支持
const refreshToken = "us-your-refresh-token-here";

// 系统会自动识别为国际版（因为以us-开头）
const response = await request(
  'POST',
  '/mweb/v1/aigc_draft/generate',
  refreshToken,
  {
    data: { /* 请求数据 */ }
  }
);
```

## Cookie字符串格式

### 新格式（推荐）

```
_key1=value1....._key2=value2....._key3=value3
```

**说明**：
- 使用"....."作为分隔符（代替"; "）
- 支持完整的cookie字段
- 必须包含`capcut_locale`字段来判断地区

### 示例

```javascript
// 国际版cookie
const internationalCookie = `
_tea_web_id=7123456789012345678.....
is_staff_user=false.....
store-region=us.....
store-region-src=uid.....
sid_guard=token123%7C1640995200%7C5184000%7CMon%2C+03-Feb-2025+08%3A17%3A09+GMT.....
uid_tt=user123.....
uid_tt_ss=user123.....
sid_tt=token123.....
sessionid=token123.....
sessionid_ss=token123.....
capcut_locale=en
`.trim().replace(/\n/g, '');

// 中国版cookie
const chinaCookie = `
_tea_web_id=7123456789012345678.....
is_staff_user=false.....
store-region=cn-gd.....
store-region-src=uid.....
sid_guard=token123%7C1640995200%7C5184000%7CMon%2C+03-Feb-2025+08%3A17%3A09+GMT.....
uid_tt=user123.....
uid_tt_ss=user123.....
sid_tt=token123.....
sessionid=token123.....
sessionid_ss=token123.....
capcut_locale=zh-CN
`.trim().replace(/\n/g, '');
```

## URL配置

### 环境变量配置

```bash
# 即梦中国服务URL
JIMENG_CN_URLS="https://jimeng.jianying.com;https://backup.jimeng.com"

# 即梦国际服务URL（多个镜像地址）
JIMENG_US_URLS="https://api-proxy-1.deno.dev/dreamina/us;https://dreamina-api.us.capcut.com;https://api.dreamina.ai/us"

# ImageX中国URL
IMAGEX_CN_URLS="https://imagex.bytedanceapi.com;https://imagex-alternate.bytedanceapi.com"

# ImageX国际URL
IMAGEX_US_URLS="https://imagex16-normal-us-ttp.capcutapi.us;https://imagex-backup.capcutapi.us"

# 商业服务URL
COMMERCE_US_URLS="https://commerce.us.capcut.com;https://commerce-backup.capcut.com"
```

### 配置文件

创建`config.yml`文件：

```yaml
urls:
  jimeng-cn:
    name: "即梦中国"
    urls: "https://jimeng.jianying.com"
    strategy: "random"
    timeout: 30000

  jimeng-us:
    name: "即梦国际"
    urls: "https://api-proxy-1.deno.dev/dreamina/us;https://dreamina-api.us.capcut.com"
    strategy: "round-robin"
    timeout: 30000
```

## 服务类型

系统支持多种服务类型，根据请求自动选择合适的URL：

| 服务类型 | 说明 | 默认URL |
|---------|------|---------|
| `jimeng` | 即梦主服务 | jimeng-cn/jimeng-us |
| `imagex` | 图片存储服务 | imagex-cn/imagex-us |
| `commerce` | 商业服务 | commerce-us/us |

### 使用示例

```javascript
// 生成图片（使用jimeng服务）
await request('POST', '/mweb/v1/aigc_draft/generate', cookieString, {
  serviceType: 'jimeng'
});

// 上传图片（使用imagex服务）
await request('POST', '/mweb/v1/get_upload_image_proof', cookieString, {
  serviceType: 'imagex'
});

// 查询积分（使用commerce服务）
await request('POST', '/commerce/v1/benefits/user_credit', cookieString, {
  serviceType: 'commerce'
});
```

## 高级功能

### 自定义URL

```javascript
// 为特定请求自定义URL
const response = await request('POST', '/api/endpoint', cookieString, {
  serviceType: 'jimeng',
  customUrls: {
    baseUrl: 'https://custom-api.example.com'
  }
});
```

### 指定地区

```javascript
// 强制使用特定地区的API
const response = await request('POST', '/api/endpoint', cookieString, {
  region: 'us',  // 强制使用国际版
  serviceType: 'jimeng'
});
```

### 认证信息管理

```javascript
import { getAuthInfoForRequest, AuthManager } from './api/controllers/core-enhanced';

// 获取详细认证信息
const authInfo = await getAuthInfoForRequest(cookieString, {
  region: 'us'
});

console.log('认证信息:', {
  region: authInfo.region,
  aid: authInfo.aid,
  baseUrl: authInfo.baseUrl,
  cookieInfo: authInfo.cookieInfo
});

// 清除认证缓存
AuthManager.getInstance().refreshAuthInfo(cookieString);
```

## 错误处理

### Cookie解析错误

```javascript
import { CookieManager } from './lib/auth/cookie-manager';

try {
  const parsed = CookieManager.parseCookie(cookieString);
  console.log('解析成功:', parsed);
} catch (error) {
  console.error('Cookie解析失败:', error.message);
  // 可以尝试使用旧格式
}
```

### URL配置错误

```javascript
import { URLManager } from './lib/config/url-manager';

const urlManager = URLManager.getInstance();

// 获取配置统计
const stats = urlManager.getConfigStats();
console.log('URL配置统计:', stats);

// 测试URL可用性
const isAvailable = await urlManager.testURLAvailability('https://api.example.com');
console.log('URL可用性:', isAvailable);
```

## 最佳实践

### 1. Cookie管理

```javascript
// 推荐的cookie字符串生成函数
function generateCookieString(token, region = 'cn') {
  const WEB_ID = Math.random() * 999999999999999999 + 7000000000000000000;
  const USER_ID = require('crypto').randomUUID();
  const timestamp = Date.now();

  const cookieFields = {
    '_tea_web_id': WEB_ID,
    'is_staff_user': 'false',
    'store-region': region === 'us' ? 'us' : 'cn-gd',
    'store-region-src': 'uid',
    'sid_guard': `${token}%7C${timestamp}%7C5184000%7CMon%2C+03-Feb-2025+08%3A17%3A09+GMT`,
    'uid_tt': USER_ID,
    'uid_tt_ss': USER_ID,
    'sid_tt': token,
    'sessionid': token,
    'sessionid_ss': token,
    'capcut_locale': region === 'us' ? 'en' : 'zh-CN'
  };

  return Object.entries(cookieFields)
    .map(([key, value]) => `${key}=${value}`)
    .join('.....');
}

// 使用示例
const cookieString = generateCookieString('your-token', 'us');
```

### 2. 错误重试

```javascript
async function robustRequest(method, uri, authString, options = {}) {
  const maxRetries = 3;
  let lastError;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await request(method, uri, authString, options);
    } catch (error) {
      lastError = error;

      if (attempt < maxRetries && isRetryableError(error)) {
        const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
        console.log(`请求失败，${delay}ms后重试 (${attempt}/${maxRetries})`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  throw lastError;
}

function isRetryableError(error) {
  const retryableMessages = ['timeout', 'network', 'connection', 'rate limit'];
  return retryableMessages.some(msg =>
    error.message.toLowerCase().includes(msg)
  );
}
```

### 3. 性能监控

```javascript
import { AuthManager } from './api/controllers/core-enhanced';

// 定期检查认证缓存状态
setInterval(() => {
  const authManager = AuthManager.getInstance();
  const stats = authManager.getAuthStats();

  console.log('认证缓存状态:', {
    缓存大小: stats.cacheSize,
    缓存条目: stats.cacheEntries.length
  });

  // 清理过期缓存
  if (stats.cacheSize > 100) {
    authManager.clearCache();
    console.log('已清理认证缓存');
  }
}, 5 * 60 * 1000); // 每5分钟检查一次
```

## 迁移指南

### 从旧版本迁移

1. **保持现有代码兼容**：
   ```javascript
   // 旧代码仍然可以工作
   const response = await request('POST', '/api/endpoint', refreshToken, options);
   ```

2. **逐步升级到新格式**：
   ```javascript
   // 逐步替换为新的cookie字符串
   const newCookieString = generateCookieString(token, detectRegion(refreshToken));
   const response = await request('POST', '/api/endpoint', newCookieString, options);
   ```

3. **配置URL轮询**：
   ```bash
   # 设置环境变量
   export JIMENG_US_URLS="https://api1.example.com;https://api2.example.com"
   ```

### 测试新功能

```javascript
// 测试cookie解析
import { CookieManager } from './lib/auth/cookie-manager';

function testCookieParsing() {
  const testCases = [
    // 新格式测试
    {
      input: "sessionid=token123.....capcut_locale=en",
      expected: { isUS: true, region: 'us' }
    },
    // 旧格式测试
    {
      input: "us-token123",
      expected: { isUS: true, region: 'us' }
    },
    // 中国版测试
    {
      input: "sessionid=token456.....capcut_locale=zh-CN",
      expected: { isUS: false, region: 'cn' }
    }
  ];

  testCases.forEach(({ input, expected }, index) => {
    try {
      const result = CookieManager.parseCookie(input);
      const passed = result.isUS === expected.isUS && result.region === expected.region;
      console.log(`测试用例 ${index + 1}: ${passed ? '✅ 通过' : '❌ 失败'}`);
    } catch (error) {
      console.log(`测试用例 ${index + 1}: ❌ 解析失败 - ${error.message}`);
    }
  });
}
```

## 故障排除

### 常见问题

1. **Cookie格式错误**
   ```
   错误: Cookie字符串格式无效
   解决: 检查分隔符是否为"....."，确保包含capcut_locale字段
   ```

2. **URL配置错误**
   ```
   错误: URL配置不存在
   解决: 检查环境变量或配置文件中的URL设置
   ```

3. **地区判断错误**
   ```
   错误: 无法确定地区
   解决: 确保cookie中包含capcut_locale字段
   ```

### 调试工具

```javascript
// 调试cookie解析
function debugCookie(cookieString) {
  console.log('输入cookie:', cookieString.substring(0, 100) + '...');

  try {
    const parsed = CookieManager.parseCookie(cookieString);
    console.log('解析结果:', {
      token: parsed.token.substring(0, 10) + '...',
      isUS: parsed.isUS,
      region: parsed.region,
      additionalFields: Object.keys(parsed.additionalInfo)
    });
  } catch (error) {
    console.error('解析失败:', error.message);
  }
}

// 调试URL配置
function debugURLConfig() {
  const urlManager = URLManager.getInstance();
  const stats = urlManager.getConfigStats();

  console.log('URL配置统计:');
  Object.entries(stats).forEach(([name, config]) => {
    console.log(`  ${name}:`);
    console.log(`    策略: ${config.strategy}`);
    console.log(`    URL数量: ${config.urlCount}`);
    console.log(`    URLs: ${config.urls.join(', ')}`);
  });
}
```

## 总结

新的认证机制提供了更强大的功能和更好的用户体验：

- ✅ **向后兼容**: 现有代码无需修改
- ✅ **智能解析**: 自动识别cookie格式和地区
- ✅ **多地址支持**: 故障转移和负载均衡
- ✅ **性能优化**: 缓存和重试机制
- ✅ **易于配置**: 环境变量和配置文件支持

建议逐步迁移到新的cookie格式，并配置多个镜像URL以提高可用性。
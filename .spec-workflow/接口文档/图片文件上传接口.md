# 图片文件上传接口文档

## 接口概述

**接口功能**: 将图片文件上传到ImageX存储服务器

**请求方法**: POST
**接口路径**: `/upload/v1/{store_uri}`
**服务提供商**: ImageX存储服务器
**内容类型**: application/octet-stream
**支持区域**: 即梦中国、即梦国际

## 请求参数

### 路径参数 (Path Parameters)

| 参数名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| store_uri | string | 是 | 存储URI，从申请上传权限接口获取 |

### 请求头 (Request Headers)

| 头部名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| Authorization | string | 是 | 认证令牌，从申请上传权限获取 |
| Content-CRC32 | string | 是 | 文件内容的CRC32校验码 |
| Content-Disposition | string | 是 | 内容 disposition，固定值 |
| Content-Type | string | 是 | 内容类型，固定值 |
| User-Agent | string | 是 | 用户代理标识 |
| X-Storage-U | string | 是 | 存储用户标识 |

### ���求体 (Request Body)

| 参数名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| image_data | binary | 是 | 图片文件的二进制数据 |

## 请求URL构建

### 完整上传URL

```
https://{upload_host}/upload/v1/{store_uri}
```

其中：
- `{upload_host}`: 从申请上传权限接口的UploadHosts数组中选择
- `{store_uri}`: 从StoreInfos[0].StoreUri获取

## 请求头详细说明

### 必需头部

```javascript
{
  "Authorization": "Bearer auth_token_string",
  "Content-CRC32": "12345678",  // 8位十六进制CRC32
  "Content-Disposition": "attachment; filename=\"undefined\"",
  "Content-Type": "application/octet-stream",
  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36",
  "X-Storage-U": "704135154117550"
}
```

### 推荐头部（优化性能）

```javascript
{
  "Accept": "*/*",
  "Accept-Encoding": "gzip, deflate, br, zstd",
  "Accept-Language": "zh-CN,zh;q=0.9",
  "Cache-Control": "no-cache",
  "Connection": "keep-alive",
  "Pragma": "no-cache",
  "Sec-Fetch-Dest": "empty",
  "Sec-Fetch-Mode": "cors",
  "Sec-Fetch-Site": "cross-site"
}
```

## CRC32计算

### CRC32算法实现

```javascript
function calculateCRC32(buffer: ArrayBuffer): string {
  const crcTable = [];

  // 生成CRC32查找表
  for (let i = 0; i < 256; i++) {
    let crc = i;
    for (let j = 0; j < 8; j++) {
      crc = (crc & 1) ? (0xEDB88320 ^ (crc >>> 1)) : (crc >>> 1);
    }
    crcTable[i] = crc;
  }

  // 计算CRC32
  let crc = 0 ^ (-1);
  const bytes = new Uint8Array(buffer);

  for (let i = 0; i < bytes.length; i++) {
    crc = (crc >>> 8) ^ crcTable[(crc ^ bytes[i]) & 0xFF];
  }

  // 转换为8位十六进制字符串
  return ((crc ^ (-1)) >>> 0).toString(16).padStart(8, '0');
}
```

### CRC32计算示例

```javascript
// 对于图片文件
const imageBuffer = await fs.readFile('image.jpg');
const crc32 = calculateCRC32(imageBuffer);
console.log(crc32); // 输出: "a1b2c3d4"
```

## 请求示例

### 完整上传示例

```javascript
async function uploadImageFile(uploadHost, storeUri, auth, imageBuffer) {
  // 计算CRC32
  const crc32 = calculateCRC32(imageBuffer);

  // 构建上传URL
  const uploadUrl = `https://${uploadHost}/upload/v1/${storeUri}`;

  // 构建请求头
  const headers = {
    'Authorization': auth,
    'Content-CRC32': crc32,
    'Content-Disposition': 'attachment; filename="undefined"',
    'Content-Type': 'application/octet-stream',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36',
    'X-Storage-U': '704135154117550',
    'Accept': '*/*',
    'Accept-Encoding': 'gzip, deflate, br, zstd',
    'Accept-Language': 'zh-CN,zh;q=0.9',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive',
    'Pragma': 'no-cache',
    'Sec-Fetch-Dest': 'empty',
    'Sec-Fetch-Md': 'cors',
    'Sec-Fetch-Site': 'cross-site'
  };

  try {
    const response = await fetch(uploadUrl, {
      method: 'POST',
      headers: headers,
      body: imageBuffer,
      timeout: 60000 // 60秒超时
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`上传失败: ${response.status} - ${errorText}`);
    }

    return response;
  } catch (error) {
    console.error('图片上传失败:', error);
    throw error;
  }
}
```

### 使用示例

```javascript
// 从申请上传权限接口获取的参数
const uploadAddress = {
  UploadHosts: ["imagex-server.example.com"],
  StoreInfos: [{
    StoreUri: "upload/v1/abc123def456",
    Auth: "Bearer auth_token_string"
  }]
};

// 读取图片文件
const imageBuffer = fs.readFileSync('example.jpg');

// 执行上传
const response = await uploadImageFile(
  uploadAddress.UploadHosts[0],
  uploadAddress.StoreInfos[0].StoreUri,
  uploadAddress.StoreInfos[0].Auth,
  imageBuffer
);

console.log('上传成功:', response.status);
```

## 响应结构

### 成功响应 (200)

上传成功时，响应体通常为空，状态码为200。

```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 0
Date: Wed, 01 Jan 2025 00:00:00 GMT
Server: ImageX/1.0
```

### 错误响应

#### 400 Bad Request

```json
{
  "error": "Invalid CRC32",
  "message": "Content-CRC32 header does not match file content"
}
```

#### 401 Unauthorized

```json
{
  "error": "Invalid authorization",
  "message": "Authorization token is invalid or expired"
}
```

#### 403 Forbidden

```json
{
  "error": "Access denied",
  "message": "No permission to upload to this URI"
}
```

#### 413 Payload Too Large

```json
{
  "error": "File too large",
  "message": "File size exceeds maximum allowed limit"
}
```

#### 500 Internal Server Error

```json
{
  "error": "Internal server error",
  "message": "Server encountered an error processing the request"
}
```

## 文件大小限制

| 图片类型 | 最大大小 | 说明 |
|----------|---------|------|
| 普通图片 | 50MB | JPG, PNG, WebP等格式 |
| 高清图片 | 100MB | 高分辨率或无损格式 |
| 动图GIF | 20MB | GIF格式文件 |

## 支持的图片格式

### 标准格式
- **JPEG/JPG**: `.jpg`, `.jpeg`
- **PNG**: `.png`
- **WebP**: `.webp`
- **GIF**: `.gif`
- **BMP**: `.bmp`

### 高级格式
- **TIFF**: `.tif`, `.tiff`
- **HEIC/HEIF**: `.heic`, `.heif`
- **AVIF**: `.avif`

## 性能优化建议

### 上传优化

1. **文件压缩**: 在上传前适当压缩图片
2. **分片上传**: 大文件考虑分片上传
3. **断点续传**: 实现断点续传功能
4. **并发控制**: 控制并发上传数量

### 网络优化

1. **超时设置**: 设置合理的超时时间
2. **重试机制**: 实现指数退避重试
3. **网络监控**: 监控网络状态变化
4. **备用服务器**: 多个上传主机选择

### 错误处理

```javascript
async function uploadWithRetry(uploadParams, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await uploadImageFile(uploadParams);
    } catch (error) {
      if (attempt === maxRetries) {
        throw error;
      }

      // 指数退避
      const delay = Math.min(1000 * Math.pow(2, attempt - 1), 30000);
      console.log(`上传失败，${delay/1000}秒后重试 (尝试 ${attempt}/${maxRetries})`);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}
```

## 安全考虑

### 数据安全

1. **HTTPS**: 确保使用HTTPS加密传输
2. **校验和**: 使用CRC32验证数据完整性
3. **认证令牌**: 保护认证令牌不被泄露
4. **文件验证**: 上传后验证文件完整性

### 访问控制

1. **令牌时效性**: 检查认证令牌有效期
2. **权限验证**: 验证用户上传权限
3. **IP限制**: 考虑IP白名单限制
4. **频率限制**: 实现上传频率限制

## 监控和日志

### 关键指标

```javascript
const uploadMetrics = {
  startTime: Date.now(),
  fileSize: imageBuffer.length,
  uploadSpeed: 0,
  status: 'uploading'
};

// 上传完成后
uploadMetrics.uploadSpeed = uploadMetrics.fileSize / (Date.now() - uploadMetrics.startTime) * 1000;
uploadMetrics.status = 'completed';

console.log('上传速度:', uploadMetrics.uploadSpeed, 'bytes/sec');
console.log('上传时间:', (Date.now() - uploadMetrics.startTime), 'ms');
```

### 日志记录

```javascript
console.log('图片上传开始:', {
  fileName: 'example.jpg',
  fileSize: imageBuffer.length,
  uploadHost: uploadHost,
  storeUri: storeUri,
  crc32: crc32
});

console.log('图片上传完成:', {
  status: response.status,
  uploadTime: Date.now() - startTime,
  uploadSpeed: imageBuffer.length / (Date.now() - startTime) * 1000
});
```

## 故障排查

### 常见问题

1. **CRC32校验失败**: 检查文件传输完整性
2. **认证失败**: 验证Authorization令牌有效性
3. **超时**: 增加超时时间或检查网络连接
4. **文件过大**: 压缩文件或使用分片上传

### 调试信息

```javascript
// 调试请求
console.log('上传请求详情:', {
  url: uploadUrl,
  headers: {
    Authorization: '***隐藏***',
    'Content-CRC32': crc32,
    'Content-Type': 'application/octet-stream',
    'Content-Length': imageBuffer.length
  }
});
```